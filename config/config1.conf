# =========================================
# CONFIG MANDATORY 1 - SINGLE SERVER
# - multi-ports
# - default error pages
# - client_max_body_size
# - routes avec :
#   * allowed_methods (GET/POST/DELETE)
#   * redirection
#   * root
#   * autoindex on/off
#   * index
#   * upload (enable + store)
#   * CGI (1 type minimum)
# =========================================

server {
    # -------------------------
    # Interfaces / Ports
    # -------------------------
    # Ton serveur doit écouter plusieurs ports.
    listen          127.0.0.1:8080;
    listen          127.0.0.1:8081;

    # -------------------------
    # Racine par défaut + index
    # (pour servir un site statique)
    # -------------------------
    root            /var/www/site1;
    index           index.html index.htm;

    # -------------------------
    # Taille max du body
    # -------------------------
    client_max_body_size 10000000; #10M

    # -------------------------
    # Pages d’erreur par défaut
    # -------------------------
    error_page      400 401 403 /errors/4xx.html;
    error_page      404         /errors/404.html;
    error_page      500 502 503 504 /errors/5xx.html;

    # =========================
    # LOCATION /
    # - sert une page statique
    # - GET autorisé
    # - index + autoindex off
    # =========================
    location / {
        allowed_methods     GET;

        root                /var/www/site1/public;
        index               index.html index.htm;
        autoindex           off;
    }

    # =========================
    # LOCATION /files/
    # - listing de répertoire
    # - GET
    # - autoindex on
    # =========================
    location /files/ {
        allowed_methods     GET;

        root                /var/www/site1/files;
        index               index.html;
        autoindex           on;
    }

    # =========================
    # LOCATION /upload/
    # - upload de fichiers
    # - POST
    # - storage location
    # =========================
    location /upload/ {
        allowed_methods     POST;

        root                /var/www/site1;
        upload_enable       on;
        upload_store        /var/www/site1/uploads;

        # Ici on peut accepter un body plus gros si tu veux,
        # mais ce n’est pas obligatoire de configurer ça par location.
        autoindex           off;
        index               upload.html;
    }

    # =========================
    # LOCATION /delete/
    # - DELETE (obligatoire comme méthode supportée)
    # =========================
    location /delete/ {
        allowed_methods     DELETE;

        root                /var/www/site1/deletable;
        autoindex           off;
        index               index.html;
    }

    # =========================
    # LOCATION /redirect/
    # - Exemple de redirection HTTP
    # =========================
    location /redirect/ {
        allowed_methods     GET;

        # Redirection (HTTP redirection obligatoire en feature)
        return              301 /;
    }

    # =========================
    # LOCATION /cgi/
    # - CGI pour une extension (.php)
    # - 1 type de CGI minimum
    # =========================
    location /cgi/ {
        allowed_methods     GET POST;

        root                /var/www/site1/cgi-bin;

        # CGI pour les fichiers .php
        cgi_extension       .php;
        cgi_pass            /usr/bin/php-cgi;

        autoindex           off;
        index               index.php;
    }

    # =========================
    # LOCATION /errors/
    # - sert les fichiers d’erreur custom
    # =========================
    location /errors/ {
        allowed_methods     GET;

        root                /var/www/site1;
        autoindex           off;
        index               404.html 4xx.html 5xx.html;
    }
}
